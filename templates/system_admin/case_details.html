{% extends 'system_admin/base.html' %}

{% load staticfiles %}

{% block theme_styles %}
<link href="{% static 'theme/bs3/css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'theme/css/bootstrap-reset.css' %}" rel="stylesheet">
<link href="{% static 'theme/font-awesome/css/font-awesome.css' %}" rel="stylesheet" />

<link href="{% static 'theme/js/iCheck/skins/minimal/minimal.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/red.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/green.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/blue.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/yellow.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/purple.css' %}" rel="stylesheet">

<link href="{% static 'theme/js/iCheck/skins/square/square.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/red.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/green.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/blue.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/yellow.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/purple.css' %}" rel="stylesheet">

<link href="{% static 'theme/js/iCheck/skins/flat/grey.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/red.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/green.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/blue.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/yellow.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/purple.css' %}" rel="stylesheet">

<link href="{% static 'theme/js/bootstrap-datepicker/css/datepicker.css' %}" rel="stylesheet">   
<link href="{% static 'theme/js/bootstrap-daterangepicker/daterangepicker-bs3.css' %}" rel="stylesheet" >

<link href="{% static 'theme/js/select2/select2.css' %}" rel="stylesheet" />


<link rel="stylesheet" type="text/css" href="{% static 'theme/js/jquery-tags-input/jquery.tagsinput.css' %}" />

<!-- Custom styles for this template -->
<link href="{% static 'theme/css/style.css' %}" rel="stylesheet">
<link href="{% static 'theme/css/style-responsive.css' %}" rel="stylesheet" />
{% endblock theme_styles %}

{% block other_styles %}
<link rel="stylesheet" href="{% static 'case_details/css/style.css' %}">
<link rel="stylesheet" href="{% static 'investigator/css/style.css' %}">
<style>
    
    .law-firm-select, .country-select-dropdown {
        padding: 0;
    }
    
    .law-firm-select > .select2-choice, .country-select-dropdown > .select2-choice {
        height: 100%;
    }
    
    .client-button {
        color: #888888;
    }
    
    .form-row {
        margin-bottom: 10px;
    }
    
    .popup-form-data .label {
        font-weight: bold;
        display: inline-block;
        vertical-align: middle;
        width: 45%;
        color: rgb(84, 84, 84);
        text-align: left;
    }
    
    .popup-form-data .value {
        display: inline-block;
        vertical-align: middle;
        width: 50%;
        color: rgb(84, 84, 84);
        text-align: left;
    }
    
    .file-holder.hidden {
        display: none;
    }
</style>
{% endblock other_styles %}

{% load range_filter %}

{% block content %}

<form action="." method="post" enctype="multipart/form-data" class="form-horizontal bucket-form">
    <div class="tab-target show" data-target-value="case-details">
        <div class="row">
            <div class="col-sm-12">
                <section class="panel">
                    <header class="panel-heading" >
                        Case Details
                        <span class="pull-right panel-buttons">
                             {% if not case.is_investigator_paid %}
                             <button type="button" class="btn btn-danger" id="markAsPaidBtn">Mark as paid</button>
                             {% else %}
                             <button type="button" class="btn btn-success" id="markAsUnpaidBtn">Mark as unpaid</button>
                             {% endif %}
                         </span>
                    </header>
                    <div class="panel-body">
                        {% csrf_token %}
                        <input type="hidden" name="context" value="update-case-details">
                        {% include 'case_form_snippet.html' %}
                    </div>
                </section>
            </div>
        </div>

        {% if editable %}
        <div class="row">
            <div class="col-sm-12">
                <div class="form-buttons case-edit-button" style="width: 200px;">
                    <button type="button" class="btn btn-success">Edit case details</button>
                    <button type="submit" class="btn btn-info">Update case details</button>
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>
</form>

{% endblock content %}


{% block theme_scripts %}
<script src="{% static 'theme/js/jquery.js' %}"></script>
<script src="{% static 'theme/bs3/js/bootstrap.min.js' %}"></script>
<script src="{% static 'theme/js/jquery.dcjqaccordion.2.7.js' %}" class="include"></script>
<script src="{% static 'theme/js/jquery.scrollTo.min.js' %}"></script>
<script src="{% static 'theme/js/jQuery-slimScroll-1.3.0/jquery.slimscroll.js' %}"></script>
<script src="{% static 'theme/js/jquery.nicescroll.js' %}"></script>
<!--Easy Pie Chart-->
<script src="{% static 'theme/js/easypiechart/jquery.easypiechart.js' %}"></script>
<!--Sparkline Chart-->
<script src="{% static 'theme/js/sparkline/jquery.sparkline.js' %}"></script>
<!--jQuery Flot Chart-->
<script src="{% static 'theme/js/flot-chart/jquery.flot.js' %}"></script>
<script src="{% static 'theme/js/flot-chart/jquery.flot.tooltip.min.js' %}"></script>
<script src="{% static 'theme/js/flot-chart/jquery.flot.resize.js' %}"></script>
<script src="{% static 'theme/js/flot-chart/jquery.flot.pie.resize.js' %}"></script>

<script src="{% static 'theme/js/bootstrap-datepicker/js/bootstrap-datepicker.js' %}"></script>
<script src="{% static 'theme/js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js' %}"></script>

<script src="{% static 'theme/js/iCheck/jquery.icheck.js' %}"></script>
<script src="{% static 'theme/js/jquery.validate.min.js' %}"></script>

<script type="text/javascript" src="{% static 'theme/js/ckeditor/ckeditor.js' %}"></script>
<script src="{% static 'common/js/jquery.inputmask.bundle.min.js' %}"></script>
<script src="{% static 'theme/js/select2/select2.js' %}"></script>

<script src="{% static 'theme/js/jquery-tags-input/jquery.tagsinput.js' %}"></script>

<!--common script init for all pages-->
<script src="{% static 'theme/js/scripts.js' %}"></script>
<script src="{% static 'theme/js/icheck-init.js' %}"></script>
{% endblock theme_scripts %}

{% block other_scripts %}
<script>
    var case_id = Number.parseInt("{{ case.pk }}"), case_status = '{{ case.status }}', law_firm_id =  Number.parseInt("{{ case.law_firm.pk }}");
    var no_of_adult_signatures_required = "{{ case.number_of_adult_signatures_required }}", no_of_child_signatures_required = "{{case.number_of_child_signatures_required}}";
    case_status = case_status.toLocaleLowerCase();
    var case_type_description = "{{case.type_description}}"
    case_status = case_status.split(' ').join('-');
    $('input[name="case-status-radio"][value="' + case_status + '"]').prop('checked', true);
    $('select[name="law-firm"]').val(law_firm_id);
    $('select[name="country"]').val('{{ case.client_address.country }}');
    $('select[name="locality"]').val('{{ case.locality }}');
    


    $('#case-type').on('change',function(event){
        if($('#case-type').val() != 'Others'){
            $('#case-type-description').attr('disabled','disabled').attr('required',false).val('').attr('placeholder','');
            
        }else{

            $('#case-type-description').attr('disabled',false).attr('required',true).attr('placeholder','Max. 200 chars').val(case_type_description);

        }
    });

    $('#case-type-description').on('change',function(ev){
        case_type_description = $(this).val(); 
    });
        
    $('#adult-clients').tagsInput({
        width:'auto',
        defaultText: 'Add client'
    });
    $('#child-clients').tagsInput({
        width:'auto',
        defaultText: 'Add client'
    });
    
    $('input[name=dol]').datepicker();
    $('input[name=edos]').datepicker();
    $('input[name=dos]').datepicker();
    $('input[name=edos]').datepicker('setDate','{{ case.expected_closing_date | date:"m/d/o" }}');
    $('input[name=dol]').datepicker('setDate', '{{ case.dol | date:"m/d/o" }}');
    $('input[name=dos]').datepicker('setDate', '{{ case.date_of_signup | date:"m/d/o" }}');
    $('input[name=closing-date]').datepicker('setDate', '{{ case.closing_date | date:"m/d/o" }}');
</script>
<script src="{% static 'broker/js/details.js' %}"></script>
<script>
    $('#navigation-button').html('<i class="fa fa-chevron-left"></i> Back');
    $('#navigation-button').click(function () {
        history.back();
    });
    
    $.validator.addMethod('phone', function (value) {
        if (value == '') {
            return true;
        }
        
        return /^\+\d \d\d\d\-\d\d\d\-\d\d\d\d$/.test(value); 
    }, 'Please enter a valid phone number.');
    
    $.validator.addMethod('format', function (value, element) {
        
         if (value == '') {
             return true;
         }
         return value.match(/^\d\d?\/\d\d?\/\d\d\d\d$/)
     }, 'Please enter date in this format (mm-dd-yyyy)');
     
     $.validator.addMethod('minDate', function (value) {
        
         if (value == '') {
             return true;
         }
         var inputDate = new Date(value);
         year = inputDate.getYear()
         if (year < 0)
         {
             return false;
         }
         else
         {
             return true;
         }
 
        
     }, 'Please enter a valid date');
     $('form').validate({
         rules: {
             'mobile-phone': {
                 phone: true
             },
             'home-phone': {
                 phone: true
             },
             'dol':{
                 format : true,
                 minDate : true
             },
             'dos':{
                 format : true,
                 minDate : true
             },
             'edos':{
                 format : true,
                 minDate : true
             }
         }
     });
    
    $('input[name*=phone]').inputmask('+9 999-999-9999');
    
    $('input:not(.swal2-input), textarea:not(.swal2-input)').attr('readonly', 'readonly');
    $('select').attr('disabled', 'disabled');
    $('.document-holder').hide()
    $('.delete-document').hide()
    {% if editable %}
    

    $('.form-buttons.case-edit-button').one('click', function() {
        
        $(this).toggleClass('editing');
        $('input, textarea').removeAttr('readonly');
        $('select').removeAttr('disabled');
        $('.rating').toggleClass('fixed');
        $('.fileupload .btn').toggleClass('editing');
        // $('.file-holder').toggleClass('hidden');
        $('#country-select').select2({
            width: '100%'
        });
        $('.law-firm-select').select2({
            width: '100%'
        });
        $('.law-firm-select').attr('disabled','disabled')
        $('.delete-document').show()
        $('.document-holder').show()
        // $('input[name=dos]').attr('readonly','readonly');
        $("#phone-number-two-link").removeAttr("href")
        $("#phone-number-one-link").removeAttr("href")
        
    });
    
    {% endif %}
    {% if updated %}
        swal({
            title: 'Case updated',
            text: 'The case has been updated',
            type: 'success',
            timer: 2000,
            showConfirmButton: false
        });
    {% endif %}
    
    
    $('#markAsPaidBtn').click(function () {
        'use strict';
        swal({
            title: 'Mark as paid', 
            text: 'Are you sure?', 
            type: 'question',
            confirmButtonText: 'Yes',
            showCancelButton: true,
            cancelButtonText: 'No'
        }).then(function () {
            $.post(location.pathname, {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                context: 'pay'
            }, function () {
                swal({
                    title: 'Success!',
                    text: 'The case has been paid',
                    type: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                setTimeout(function () {
                    location.reload();
                }, 2000);
            });
        });
        return false;
        
    });
    
    $('#markAsUnpaidBtn').click(function () {
        'use strict';
        swal({
            title: 'Mark as unpaid', 
            text: 'Are you sure?', 
            type: 'question',
            confirmButtonText: 'Yes',
            showCancelButton: true,
            cancelButtonText: 'No'
        }).then(function () {
            $.post(location.pathname, {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                context: 'unpay'
            }, function () {
                swal({
                    title: 'Success!',
                    text: 'The case has been unpaid',
                    type: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                setTimeout(function () {
                    location.reload();
                }, 2000);
            });
        });
        return false;
    });
     $('.delete-document').click(function () {
        //  debugger
         var attached_document_id = $(this).attr('attached-document-id');
         swal({
            title: 'Delete',
            text: 'Are you sure you want delete this document?',
            type: 'warning',
            confirmButtonText: 'Yes',
            showCancelButton: true,
            cancelButtonText: 'No'
        }).then(
            function () {
            $.post('/administrator/delete-attached-document/', {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                attached_document_id: attached_document_id
            }, function () {
                swal({
                    title: 'Success!',
                    text: 'The Document is deleted',
                    type: 'success',
                    timer: 2000,
                    showConfirmButton: false
                })
                setTimeout(function () {
                    location.reload();
                }, 2000);
            }).fail(function (error) {
            
            swal({
                title: 'Unable to delete document',
                text: 'Unable to delete document as document is attached to a case',
                type: 'error',
                showConfirmButton: true

            });
        });
        })
     });
     $('.download-document').click(function () {
        //  debugger
        var document_id = $(this).attr('document-id');
        $('<form action="." method="POST"></form>')
            .append($('<input>', {
                'name': 'csrfmiddlewaretoken',
                'value': $('input[name=csrfmiddlewaretoken]').val(),
                'type': 'hidden'
            }))
            .append($('<input>', {
                'name': 'context',
                'value':  'download-document',
                'type': 'hidden'
            })).append($('<input>', {
                'name': 'document-id',
                'value': document_id,
                'type': 'hidden'
            })).appendTo('body').submit();
     })
     $('.document-print').click(function(event){
        //  event.preventDefault()
        var document_id = $(this).attr('document-id');
        $('<form action="." method="POST" target="_blank"></form>')
            .append($('<input>', {
                'name': 'csrfmiddlewaretoken',
                'value': $('input[name=csrfmiddlewaretoken]').val(),
                'type': 'hidden'
            }))
            .append($('<input>', {
                'name': 'context',
                'value':  'view-document',
                'type': 'hidden'
            })).append($('<input>', {
                'name': 'document-id',
                'value': document_id,
                'type': 'hidden'
            })).appendTo('body').submit();
     })

     //  $('.law-firm-select').change(function () {
    //   debugger
    //     var  law_firm_id = $(this).val();
    //         checkboxList = $('<span></span>')
    //         checkbox = null
    //         {% for document in all_documents %}
            
            
    //         if ( {{document.law_firm.pk}} == law_firm_id )
    //         {
    //         checkbox = $('<input type="checkbox" name="document" value={{document.pk}}> {{document.file_name}}</input><br>')
    //         checkboxList.append(checkbox)
    //         // $('.attach-documents').append(checkbox)
    //         }
            
    //         {% endfor %}
    //         $('.document-holder').html(checkboxList)
    //             // checkbox = $('<input type="checkbox" name="document" value="'+ returned_data['documents'] +'"/>')
    // }) 
</script>
{% endblock other_scripts %}