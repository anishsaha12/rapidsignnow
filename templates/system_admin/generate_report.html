{% extends 'system_admin/base.html' %} {% load staticfiles %} {% block theme_styles %}
<link href="{% static 'theme/bs3/css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'theme/css/bootstrap-reset.css' %}" rel="stylesheet">
<link href="{% static 'theme/font-awesome/css/font-awesome.css' %}" rel="stylesheet" />
 
 <!-- <link href="{% static 'theme/js/iCheck/skins/minimal/minimal.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/red.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/green.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/blue.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/yellow.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/minimal/purple.css' %}" rel="stylesheet">  
 
 <link href="{% static 'theme/js/iCheck/skins/square/square.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/red.css' %}" rel="stylesheet">   -->

<link href="{% static 'theme/js/iCheck/skins/square/green.css' %}" rel="stylesheet">
<!-- 
<link href="{% static 'theme/js/iCheck/skins/square/blue.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/yellow.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/square/purple.css' %}" rel="stylesheet">

<link href="{% static 'theme/js/iCheck/skins/flat/grey.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/red.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/green.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/blue.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/yellow.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/iCheck/skins/flat/purple.css' %}" rel="stylesheet">  -->

<link href="{% static 'theme/js/bootstrap-datepicker/css/datepicker.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/bootstrap-daterangepicker/daterangepicker-bs3.css' %}" rel="stylesheet">
<link href="{% static 'theme/js/bootstrap-datetimepicker/css/datetimepicker.css' %}" rel="stylesheet">

<link href="{% static 'theme/js/select2/select2.css' %}" rel="stylesheet" />

<!-- Custom styles for this template -->
<link href="{% static 'theme/css/style.css' %}" rel="stylesheet">
<link href="{% static 'theme/css/style-responsive.css' %}" rel="stylesheet" /> {% endblock theme_styles %} {% block other_styles %}
<link rel="stylesheet" href="{% static 'case_list/css/style.css' %}">
<link rel="stylesheet" href="{% static 'case_details/css/style.css' %}">
<style>
    .buttons-holder {
        text-align: center;
        margin-left: 10px;
        float:right
        
    }

    .bulk-buttons.hide {
        display: none;
    }

    .table tbody>tr>td {
        text-align: center;
        vertical-align: middle;
    }

    .table tbody>tr>td.editable-column {
        padding: 0;
        cursor: text;
    }

    .table tbody>tr>td.editable-column .fa-undo {
        position: absolute;
        top: 3px;
        right: 3px;
        display: none;
    }

    .table tbody>tr>td.editable-column.edited .fa-undo {
        display: block;
    }

    .table tbody>tr>td.editable-column.edited {
        position: relative;
        background: #d6d6d6;
    }

    .editable-column input {
        display: inline-block;
        width: 40px;
        text-align: center;
        border: none;
        background: transparent;
    }

    .editable-column input::-webkit-inner-spin-button,
    .editable-column input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .input-large {
        position: relative;
    }

    .input-large label {
        position: absolute;
        top: 35px;
        right: 15px;
    }

    .save-changes.hide {
        display: none;
    }
    .law-firm-select {
        padding: 0;
    }
    
    .law-firm-select > .select2-choice {
        height: 100%;
    }
    
    .selected-firm {
        display: block;
        margin: 20px auto;
        text-align: center;
        font-weight: bold;
        font-size: 22px;
    }
    @media only screen and (max-width: 500px) {

#cases-table{
    overflow-y:scroll;
   display:block;
    }
.bulk-buttons{
    margin-top: 10px;
    margin-left: -175px;
}
#downloadSelectedCasesAsCSVBtn{
    margin-left: -30px;
}
#downloadSelectedCasesAsCSVSpan:after {
    content: '\A';
    white-space: pre;
}
.mark-as-paid{
    margin-top: 10px;
    margin-left: -54px;
}
.mark-as-paid-span:after{
    content: '\A';
    white-space: pre;
}
.mark-as-unpaid{
    margin-top: 10px;
    margin-left: -42px;
}
.mark-as-unpaid-span:after{
    content: '\A';
    white-space: pre;
}
}
</style>
{% endblock other_styles %} {% load range_filter %} {% block content %}

<div class="row">
    <div class="col-sm-12">
        <section class="panel">
            <header class="panel-heading no-mouse-events">
                Generate Report
            </header>
            <div class="panel-body">
                <form action="." method="post" class="form-horizontal bucket-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <div class="col-sm-3 control-label col-lg-3">Law Firm <sup>*</sup></div>
                        <div class="col-lg-6">
                            <select name="law-firm" required id="" class="form-control mbot-15 law-firm-select" data-placeholder="Please select a law firm">
                                <option value=""></option>
                                <option value="All Firms">All Firms</option>
                                {% for law_firm in law_firms %}
                                <option value="{{ law_firm.pk }}">{{ law_firm.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-3 control-label col-lg-3">Date Range</div>
                        <div class="col-lg-6">
                            <div class="input-group input-large" data-date="mm/dd/yyyy" data-date-format="mm/dd/yyyy">
                                <input required type="text" class="form-control dpd1" name="from" id="from-date">
                                <span class="input-group-addon">To</span>
                                <input required type="text" class="form-control dpd2" name="to" id="to-date">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-11">
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-success">Generate Reports</button>
                        </div>
                    </div>

                </form>
                
                {% if cases %}

                <div>
                    <br>
                    <br>
                    <br>
                    <form action="." method="post" id="download-csv-form" style="display: inline-block;">
                        {% csrf_token %}
                        <input type="hidden" name="context" value="download-csv">
                        <input type="hidden" name="from" value="{{ from }}">
                        <input type="hidden" name="to" value="{{ to }}">
                        <input type="hidden" id="download-csv-form-law-firm" name="law_firm" value="{{ selected_firm.pk }}">
                        <input type="hidden" name="case-ids" value="">
                        <button class="btn btn-primary btn-sm download-csv" type="submit" form="download-csv-form" aria-expanded="false">Download all cases as CSV</button>
                        <div class="buttons-holder bulk-buttons hide">
                                <span id = "downloadSelectedCasesAsCSVSpan"><button class="btn btn-primary btn-sm" id="downloadSelectedCasesAsCSVBtn" type="button" aria-expanded="false">Download cases as CSV</button></span>
                                <span class="mark-as-paid-span"><button class="btn btn-primary btn-sm mark-as-paid" type="button" aria-expanded="false">Mark cases as paid</button></span>
                                <span class="mark-as-unpaid-span"><button class="btn btn-primary btn-sm mark-as-unpaid" type="button" aria-expanded="false">Mark cases as unpaid</button></span>
                        </div>
                    </form>
                    <button class="btn btn-primary btn-sm save-changes hide" type="button" aria-expanded="false">Save changes</button>
                    <br><br>
                    <table class="table table-striped table-hover table-bordered" id="cases-table" style="font-size: 0.8em;">
                        <thead>
                            <tr>
                                <th>
                                    <div class="square-green single-row" style="display: inline-block; width: 20px;">
                                        <input id="select-all-cases" type="checkbox">
                                    </div>
                                </th>
                                <th>Case Name</th>
                                <th>Investigator name</th>
                                <th>Adult Clients</th>
                                <th>Child Clients</th>
                                <th>Location of client</th>
                                <th>No. of miles travelled</th>
                                <th>No. of free miles</th>
                                <th>Basic fee</th>
                                <th>Mileage rate</th>
                                <th>Additional expenses</th>
                                <!-- <th>No. of signatures</th> -->
                                <th>Expected investigator payment</th>
                                <th>Law firm payout</th>
                                <th>Difference</th>
                                <th>Amount paid to investigator</th>
                                <th>Profit</th>
                                <th>Payment status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for case in cases %}
                            <tr class="case-row" data-case-id="{{ case.pk }}">
                                <td>
                                    <div class="square-green single-row" style="display: inline-block; width: 20px;">
                                        <input id="{{ case.pk }}" class="case-select-for-bulk-invoice" type="checkbox" value="{{ case.pk }}">
                                    </div>
                                </td>
                                <td><a href="/administrator/case-details/{{ case.pk }}/">{{ case.name }}</a></td>
                                <td>{{ case.investigator.user.first_name }} {{ case.investigator.user.last_name }}</td>
                                <td>{{case.adult_clients}}</td>
                                <td>{{case.child_clients}}</td>
                                <td>{{ case.client_address.simple_address }}</td>
                                {% if not case.is_investigator_paid %}
                                <td class="editable-column" data-column="no-of-miles-travelled" data-original-value="{{ case.no_of_miles_travelled }}"><i class="fa fa-undo"></i><input type="number" min="0" value="{{ case.no_of_miles_travelled }}"></td>
                                <td class="editable-column" data-column="no-of-free-miles" data-original-value="{{ case.no_of_free_miles_law_firm }}"><i class="fa fa-undo"></i><input type="number" min="0" value="{{ case.no_of_free_miles_law_firm }}"></td>
                                <td class="editable-column" data-column="basic-fee" data-original-value="{{ case.basic_fee_law_firm }}"><i class="fa fa-undo"></i><input type="number" min="0" value="{{ case.basic_fee_law_firm }}"></td>
                                <td class="editable-column" data-column="mileage-rate" data-original-value="{{ case.mileage_rate_law_firm }}"><i class="fa fa-undo"></i><input type="number" min="0" value="{{ case.mileage_rate_law_firm }}"></td>
                                <td class="editable-column" data-column="additional-expenses" data-original-value="{{ case.additional_expenses }}"><i class="fa fa-undo"></i><input type="number" min="0" value="{{ case.additional_expenses }}"></td>
                                {% else %}
                                <td class="editable-column" data-column="no-of-miles-travelled" data-original-value="{{ case.no_of_miles_travelled }}">{{ case.no_of_miles_travelled }}</td>
                                <td class="editable-column" data-column="no-of-free-miles" data-original-value="{{ case.no_of_free_miles_law_firm }}">{{ case.no_of_free_miles_law_firm }}</td>
                                <td class="editable-column" data-column="basic-fee" data-original-value="{{ case.basic_fee_law_firm }}">{{ case.basic_fee_law_firm }}</td>
                                <td class="editable-column" data-column="mileage-rate" data-original-value="{{ case.mileage_rate_law_firm }}">{{ case.mileage_rate_law_firm }}</td>
                                <td class="editable-column" data-column="additional-expenses" data-original-value="{{ case.additional_expenses }}">{{ case.additional_expenses }}</td>
                                {% endif %}
                                <!-- <td>{{ case.number_of_signatures_required }}</td> -->
                                <td>{{ case.expected_payment }}</td>
                                <td>{{ case.get_law_firm_price }}</td>
                                <td>{{ case.difference_in_payment }}</td>
                                <td>{{ case.get_investigator_price }}</td>
                                <td>{{ case.profit }}</td>
                                <td>{% if case.is_investigator_paid %} PAID {% else %} PENDING {% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    
                </div>
                {% endif %}
            </div>
        </section>
    </div>
</div>

{% endblock content %} {% block theme_scripts %}
<script src="{% static 'theme/js/jquery.js' %}"></script>
<script src="{% static 'theme/bs3/js/bootstrap.min.js' %}"></script>
<script src="{% static 'theme/js/jquery.dcjqaccordion.2.7.js' %}" class="include"></script>
<script src="{% static 'theme/js/jquery.scrollTo.min.js' %}"></script>
<script src="{% static 'theme/js/jQuery-slimScroll-1.3.0/jquery.slimscroll.js' %}"></script>
<script src="{% static 'theme/js/jquery.nicescroll.js' %}"></script>
 
 <script src="{% static 'theme/js/bootstrap-datepicker/js/bootstrap-datepicker.js' %}"></script> 
 <script src="{% static 'theme/js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js' %}"></script> 
<script src="{% static 'theme/js/bootstrap-daterangepicker/moment.min.js' %}"></script>
<script src="{% static 'theme/js/bootstrap-daterangepicker/daterangepicker.js' %}"></script>
 <script src="{% static 'theme/js/bootstrap-timepicker/js/bootstrap-timepicker.js' %}"></script> 
<script src="{% static 'theme/js/iCheck/jquery.icheck.js' %}"></script>
<script src="{% static 'theme/js/jquery.validate.min.js' %}"></script>

<!-- <script src="{% static 'theme/js/ckeditor/ckeditor.js' %}"></script> -->
<script src="{% static 'theme/js/select2/select2.js' %}"></script>

<!--common script init for all pages-->
<script src="{% static 'theme/js/scripts.js' %}"></script>
<script src="{% static 'theme/js/icheck-init.js' %}"></script>
<script src="{% static 'theme/js/advanced-form.js' %}"></script>
{% endblock theme_scripts %} {% block other_scripts %}
<script>
    var selected_cases = [];
    {% if error %}
         swal("{{ error }}","error");
    {% endif %}

    $('a[data-nav-item=generate-report]').addClass('active');
    $('#navigation-button').remove();

    $.validator.addMethod("greaterThan", function (value, element, params) {

        if (!/Invalid|NaN/.test(new Date(value))) {
            return new Date(value) > new Date($(params).val());
        }

        return isNaN(value) && isNaN($(params).val())
            || (Number(value) > Number($(params).val()));
    }, 'Must be greater than From Date.');

    $.validator.addMethod('format', function (value, element) {
        
         if (value == '') {
             return true;
         }
         return value.match(/^\d\d?\/\d\d?\/\d\d\d\d$/)
     }, 'Please enter date in this format (mm-dd-yyyy)');
     $.validator.addMethod('minDate', function (value) {
       
        if (value == '') {
            return true;
        }
        var inputDate = new Date(value);
        year = inputDate.getYear()
        if (year < 0)
        {
            return false;
        }
        else
        {
            return true;
        }

       
    }, 'Please enter a valid date');
 
     $('form').validate({
         rules: {
             to: { greaterThan: "#from-date",
                   format : true,
                     minDate: true },
                 
             from :{
                     format : true,
                     minDate: true
             }
             },
                
     });
     

    {% if selected_firm == 'All Firms' %}
    $('.law-firm-select').val('All Firms');
    $('#download-csv-form-law-firm').val('All Firms')
    {% else %}
    $('.law-firm-select').val('{{ selected_firm.pk }}');

    {% endif %}
    $('.law-firm-select').select2({
        width: '100%'
    });

    $('.save-changes').on('click', function () {

        swal({
            title: 'Save changes to all the cases',
            text: 'Are you sure?',
            type: 'question',
            confirmButtonText: 'Yes',
            showCancelButton: true,
            cancelButtonText: 'No'
        }).then(function () {
            $('.case-row').each(function () {
                var case_row = $(this), total_cases_sent = 0, total_cases_returned = 0;

                if (case_row.find('.editable-column.edited').size() == 0) {
                    return;
                }

                total_cases_sent += 1;

                $.post('/administrator/generate-report/', {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    context: 'update-table',
                    'case-id': case_row.attr('data-case-id'),
                    'number-of-miles-travelled': case_row.find('td[data-column="no-of-miles-travelled"] input').val(),
                    'number-of-free-miles': case_row.find('td[data-column="no-of-free-miles"] input').val(),
                    'basic-fee': case_row.find('td[data-column="basic-fee"] input').val(),
                    'mileage-rate': case_row.find('td[data-column="mileage-rate"] input').val(),
                    'additional-expenses': case_row.find('td[data-column="additional-expenses"] input').val()
                }, function () {
                    total_cases_returned += 1;

                    if (total_cases_returned === total_cases_sent) {
                        swal('Success', 'Changes have been saved', 'success').then(function () {
                            location.reload();
                        });
                    }
                });


            });
        });
    })

    $('.editable-column input').on('input', function () {
        $(this).parent().addClass('edited');

        if (Number($(this).parent().attr('data-original-value')) === Number($(this).val())) {
            $(this).parent().removeClass('edited');
        }

        if ($('.editable-column.edited').size() > 0) {
            $('.save-changes').removeClass('hide');
        } else {
            $('.save-changes').addClass('hide');
        }
    });

    $('.editable-column').click(function () {
        'use strict';

        $(this).find('input').focus();
    });

    $('.editable-column .fa-undo').click(function () {
        var old_value = $(this).parent().attr('data-original-value');

        $(this).next().val(old_value);
        $(this).parent().removeClass('edited');

        if ($('.editable-column.edited').size() > 0) {
            $('.save-changes').removeClass('hide');
        } else {
            $('.save-changes').addClass('hide');
        }
    });

    {% if cases %}
     
    $('input[type=text][name=from]').val('{{ from }}');
    $('input[type=text][name=to]').val('{{ to }}');
    function reselect_bulk_cases() {
        var case_rows = $('.case-row'), outer_loop, selected_case;

        selected_cases = [];

        for (outer_loop = 0; outer_loop < case_rows.size(); outer_loop += 1) {
            selected_case = case_rows.eq(outer_loop);
            if (selected_case.find('.icheckbox_square-green').hasClass('checked')) {
                selected_cases.push(selected_case.attr('data-case-id'));
            }
        }

        $('input[name="case-ids"]').val(JSON.stringify(selected_cases));

        if (selected_cases.length === 0) {
            $('.bulk-buttons').addClass('hide');
        } else {
            $('.bulk-buttons').removeClass('hide');
        }
    }

    reselect_bulk_cases();

    setInterval(reselect_bulk_cases, 1000);

    $('#downloadSelectedCasesAsCSVBtn').click(function () {
        'use strict';

        $('<form action="." method="POST"></form>')
            .append($('<input>', {
                'name': 'csrfmiddlewaretoken',
                'value': $('input[name=csrfmiddlewaretoken]').val(),
                'type': 'hidden'
            }))
            .append($('<input>', {
                'name': 'context',
                'value':  'download-csv-selected-cases',
                'type': 'hidden'
            }))
            .append($('<input>', {
                'name': 'case_ids',
                'value': JSON.stringify(selected_cases),
                'type': 'hidden'
            }))
            .appendTo('body').submit();
    });

    $('.mark-as-paid').click(function () {
        'use strict';

        swal({
            title: 'Mark as paid',
            text: 'Are you sure?',
            type: 'question',
            confirmButtonText: 'Yes',
            showCancelButton: true,
            cancelButtonText: 'No'
        }).then(function () {
            $.post(location.pathname, {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                context: 'pay',
                case_ids: JSON.stringify(selected_cases),
                from: $('#from-date').val(),
                to: $('#to-date').val()
            }, function () {
                swal({
                    title: 'Success!',
                    text: 'The cases have been paid',
                    type: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

                setTimeout(function () {
                    location.reload();
                }, 2000);
            });
        });
    });

    $('.mark-as-unpaid').click(function () {
        'use strict';

        swal({
            title: 'Mark as unpaid',
            text: 'Are you sure?',
            type: 'question',
            confirmButtonText: 'Yes',
            showCancelButton: true,
            cancelButtonText: 'No'
        }).then(function () {
            $.post(location.pathname, {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                context: 'unpay',
                case_ids: JSON.stringify(selected_cases),
                from: $('#from-date').val(),
                to: $('#to-date').val()
            }, function () {
                swal({
                    title: 'Success!',
                    text: 'The cases have been unpaid',
                    type: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

                setTimeout(function () {
                    location.reload();
                }, 2000);
            });
        });
    });

    setTimeout(function () {
        $('#select-all-cases + ins').click(function () {
            if ($(this).parent().hasClass('checked')) {
                $('.case-row .icheckbox_square-green').addClass('checked');
            } else {
                $('.case-row .icheckbox_square-green').removeClass('checked');
            }
        });
    }, 3000);

    {% endif %}

</script>
{% endblock other_scripts %}